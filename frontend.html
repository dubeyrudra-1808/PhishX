<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Phishing Detector</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f0f2f5; }
  .card { margin-top: 40px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
  #resultCard { display: none; }
  .progress { height: 20px; border-radius: 10px; }
  .feature-table { max-height: 260px; overflow-y: auto; display:block; }
  .small-muted { font-size: .85rem; color: #6c757d; }
  pre { white-space: pre-wrap; word-break: break-word; }
</style>
</head>
<body>
<div class="container">
  <div class="card p-4 mx-auto" style="max-width:720px;">
    <h3 class="mb-3 text-center">AI Phishing Detector</h3>

    <div class="row g-2 mb-3">
      <div class="col-9">
        <input type="text" id="urlInput" class="form-control" placeholder="Enter URL (e.g. https://example.com)">
      </div>
      <div class="col-3 d-grid">
        <button id="checkBtn" class="btn btn-primary">Check URL</button>
      </div>
    </div>

    <div class="card mt-3 p-3" id="resultCard">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">Status: <span id="phishStatus" class="ms-2"></span></h5>
          <div class="small-muted" id="urlShown"></div>
        </div>
        <div style="min-width:250px;">
          <div class="mb-2 small-muted text-end">Probability</div>
          <div class="progress">
            <div id="probBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-sm btn-outline-secondary" id="toggleBtn">Toggle Feature List</button>
        <button class="btn btn-sm btn-outline-info ms-2" id="showRawBtn">Show Raw Extractor</button>
      </div>

      <div id="featureTable" class="feature-table mt-3" style="display:none;">
        <table class="table table-sm table-striped mb-0">
          <thead><tr><th>Feature</th><th class="text-end">Value</th></tr></thead>
          <tbody id="featureBody"></tbody>
        </table>
      </div>

      <div id="rawBlock" style="display:none;" class="mt-3">
        <h6>Raw extractor output</h6>
        <pre id="rawPre" class="p-2 bg-light" style="border-radius:6px; max-height:240px; overflow:auto;"></pre>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'http://127.0.0.1:8000'; // change if backend is hosted elsewhere

function roundVal(v) {
  if (v === null || v === undefined) return '-';
  if (typeof v === 'number') {
    // show integer without decimals, floats to 4 significant digits
    return Math.abs(v) >= 100 ? v.toFixed(0)
          : Math.abs(v) >= 1 ? v.toFixed(3)
          : v.toFixed(4);
  }
  return String(v);
}

async function checkURL() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) { alert("Enter a URL"); return; }

  // reset UI
  document.getElementById('resultCard').style.display = 'block';
  document.getElementById('phishStatus').innerText = 'Checking...';
  document.getElementById('urlShown').innerText = '';
  const bar = document.getElementById('probBar');
  bar.style.width = '0%';
  bar.innerText = '0%';
  document.getElementById('featureBody').innerHTML = '';
  document.getElementById('rawPre').innerText = '';
  document.getElementById('rawBlock').style.display = 'none';
  document.getElementById('featureTable').style.display = 'none';

  try {
    const resp = await fetch(`${API_BASE}/predict_url`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
    const data = await resp.json();

    if (!resp.ok) {
      document.getElementById('phishStatus').innerHTML = `<span class="badge bg-warning">Error</span>`;
      document.getElementById('rawPre').innerText = JSON.stringify(data, null, 2);
      document.getElementById('rawBlock').style.display = 'block';
      return;
    }

    // show URL
    document.getElementById('urlShown').innerText = data.url || url;

    // status badge
    const isPhish = !!data.is_phishing;
    document.getElementById('phishStatus').innerHTML = `<span class="badge ${isPhish ? 'bg-danger' : 'bg-success'}">${isPhish ? 'Phishing' : 'Safe'}</span>`;

    // probability
    const prob = (typeof data.probability === 'number') ? data.probability : (Array.isArray(data.probs) ? data.probs[0] : null);
    const percent = (prob === null || prob === undefined) ? 0 : Math.round(prob * 10000) / 100;
    bar.style.width = percent + '%';
    bar.innerText = percent.toFixed(2) + '%';
    bar.className = "progress-bar " + (isPhish ? "bg-danger" : "bg-success");

    // features: prefer `data.features` (dict). Fallback to produced_feature_vector with produced_feature_names.
    const featureDict = data.features || null;
    const names = data.produced_feature_names || (featureDict ? Object.keys(featureDict) : null);
    const vector = data.produced_feature_vector || null;

    const tbody = document.getElementById('featureBody');
    tbody.innerHTML = '';

    if (names && names.length) {
      names.forEach((f, i) => {
        let v = '-';
        if (featureDict && (f in featureDict)) {
          v = featureDict[f];
        } else if (vector && i < vector.length) {
          v = vector[i];
        } else if (data.raw_features_from_extractor && (f in data.raw_features_from_extractor)) {
          v = data.raw_features_from_extractor[f];
        }
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.innerText = f;
        const tdVal = document.createElement('td');
        tdVal.className = 'text-end';
        tdVal.innerText = (v === '-' ? '-' : roundVal(v));
        tr.appendChild(tdName);
        tr.appendChild(tdVal);
        tbody.appendChild(tr);
      });
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="2">No feature data returned by backend.</td>';
      tbody.appendChild(tr);
    }

    // show raw extractor if present
    if (data.raw_features_from_extractor) {
      document.getElementById('rawPre').innerText = JSON.stringify(data.raw_features_from_extractor, null, 2);
      // keep hidden by default: user can click Show Raw
    }

  } catch (err) {
    document.getElementById('phishStatus').innerText = 'Network Error';
    document.getElementById('rawPre').innerText = String(err);
    document.getElementById('rawBlock').style.display = 'block';
    console.error(err);
  }
}

// toggles
document.getElementById('toggleBtn').addEventListener('click', () => {
  const ft = document.getElementById('featureTable');
  ft.style.display = (ft.style.display === 'none' || ft.style.display === '') ? 'block' : 'none';
});
document.getElementById('showRawBtn').addEventListener('click', () => {
  const rb = document.getElementById('rawBlock');
  rb.style.display = (rb.style.display === 'none' || rb.style.display === '') ? 'block' : 'none';
});
document.getElementById('checkBtn').addEventListener('click', checkURL);

// allow pressing Enter
document.getElementById('urlInput').addEventListener('keyup', (e) => {
  if (e.key === 'Enter') checkURL();
});
</script>
</body>
</html>
